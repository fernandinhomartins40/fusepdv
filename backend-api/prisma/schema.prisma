// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Establishment {
  id        String   @id @default(uuid())
  nome      String
  cnpj      String   @unique
  email     String   @unique
  telefone  String?
  endereco  String?
  cidade    String?
  estado    String?
  cep       String?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users              User[]
  products           Product[]
  sales              Sale[]
  nfeImports         NfeImport[]
  caixaMovimentacoes CaixaMovimentacao[]

  @@map("establishments")
}

model User {
  id              String   @id @default(uuid())
  establishmentId String
  nome            String
  email           String   @unique
  senha           String
  role            UserRole @default(OPERADOR)
  ativo           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  establishment      Establishment        @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  sales              Sale[]
  caixaMovimentacoes CaixaMovimentacao[]
  refreshTokens      RefreshToken[]

  @@map("users")
}

enum UserRole {
  ADMIN
  OPERADOR
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Product {
  id              String   @id @default(uuid())
  establishmentId String
  codigo          String
  ean             String?
  nome            String
  descricao       String?
  categoria       String?
  unidade         String   @default("UN")
  precoCusto      Decimal  @default(0) @db.Decimal(10, 2)
  precoVenda      Decimal  @db.Decimal(10, 2)
  estoque         Decimal  @default(0) @db.Decimal(10, 3)
  estoqueMinimo   Decimal? @db.Decimal(10, 3)
  ncm             String?
  cest            String?
  cfop            String?
  ativo           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  establishment Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  saleItems     SaleItem[]

  @@unique([establishmentId, codigo])
  @@index([establishmentId, ean])
  @@index([establishmentId, nome])
  @@map("products")
}

model Sale {
  id              String         @id @default(uuid())
  establishmentId String
  userId          String
  numero          Int
  data            DateTime       @default(now())
  subtotal        Decimal        @db.Decimal(10, 2)
  desconto        Decimal        @default(0) @db.Decimal(10, 2)
  total           Decimal        @db.Decimal(10, 2)
  status          SaleStatus     @default(CONCLUIDA)
  formaPagamento  String
  sincronizado    Boolean        @default(false)
  observacoes     String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  establishment Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id])
  items         SaleItem[]

  @@unique([establishmentId, numero])
  @@index([establishmentId, data])
  @@map("sales")
}

enum SaleStatus {
  CONCLUIDA
  CANCELADA
}

model SaleItem {
  id             String  @id @default(uuid())
  saleId         String
  productId      String
  quantidade     Decimal @db.Decimal(10, 3)
  precoUnitario  Decimal @db.Decimal(10, 2)
  subtotal       Decimal @db.Decimal(10, 2)
  desconto       Decimal @default(0) @db.Decimal(10, 2)

  // Relations
  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("sale_items")
}

model NfeImport {
  id              String   @id @default(uuid())
  establishmentId String
  chaveAcesso     String   @unique
  numero          String
  serie           String
  modelo          String   @default("55")
  fornecedorCnpj  String
  fornecedorNome  String
  dataEmissao     DateTime
  valorTotal      Decimal  @db.Decimal(10, 2)
  xmlContent      String   @db.Text
  produtosCount   Int      @default(0)
  createdAt       DateTime @default(now())

  // Relations
  establishment Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)

  @@index([establishmentId, dataEmissao])
  @@map("nfe_imports")
}

model CaixaMovimentacao {
  id              String              @id @default(uuid())
  establishmentId String
  userId          String
  tipo            TipoMovimentacao
  valor           Decimal             @db.Decimal(10, 2)
  saldoAnterior   Decimal             @default(0) @db.Decimal(10, 2)
  saldoAtual      Decimal             @db.Decimal(10, 2)
  observacoes     String?
  aberto          Boolean             @default(false)
  dataHora        DateTime            @default(now())
  createdAt       DateTime            @default(now())

  // Relations
  establishment Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id])

  @@index([establishmentId, dataHora])
  @@index([establishmentId, aberto])
  @@map("caixa_movimentacoes")
}

enum TipoMovimentacao {
  ABERTURA
  FECHAMENTO
  SANGRIA
  REFORCO
}
